<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Vector DB</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 2rem auto;
    }

    input {
      padding: 0.5rem;
      width: 100%;
      margin-bottom: 1rem;
    }

    button {
      padding: 0.5rem;
      margin-bottom: 1.5rem;
      width: 100%;
      cursor: pointer;
    }

    h2 {
      margin-top: 2rem;
    }

    #result {
      font-weight: bold;
      color: green;
    }

    label input[type="radio"] {
      margin-right: 5px;
    }

    label {
      margin-right: 15px;
    }
  </style>
</head>

<body>
  <h1>Vector Database</h1>

  <h2>Add a Vector</h2>
  <input id="addName" placeholder="Name (e.g., vector1)">
  <div>
    <label>Type:</label><br>
    <label><input type="radio" name="addType" value="image" checked> Image</label>
    <label><input type="radio" name="addType" value="video"> Video</label>
    <label><input type="radio" name="addType" value="text"> Text</label>
  </div>
  <input id="addVec" placeholder="Vector (e.g., 1,0.5,0.3)">
  <button onclick="addVector()">Add Vector</button>

  <h2>Search Vector</h2>
  <input id="searchVec" placeholder="Vector (e.g., 1,0.5,0.3)">
  <button onclick="searchVector()">Search</button>

  <h2>Search Result</h2>
  <div id="result">No result yet.</div>

  <h2>All Stored Vectors</h2>
  <button onclick="fetchAllVectors()">Refresh List</button>
  <table id="vectorsTable" border="1" cellpadding="5" cellspacing="0"
    style="margin-top: 1rem; width: 100%; border-collapse: collapse;">
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Vector (values)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>3D Vector Visualization</h2>
  <canvas id="vectorCanvas" style="width:100%; height:400px; border:1px solid #ccc;"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
  <script>let scene, camera, renderer;

    function init3DScene() {
      const canvas = document.getElementById("vectorCanvas");

      scene = new THREE.Scene();
      scene.background = new THREE.Color(0xf0f0f0);

      camera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
      camera.position.set(5, 5, 10);
      camera.lookAt(0, 0, 0);

      renderer = new THREE.WebGLRenderer({ canvas: canvas });
      renderer.setSize(canvas.clientWidth, canvas.clientHeight);

      // Light
      const light = new THREE.PointLight(0xffffff, 1);
      light.position.set(10, 10, 10);
      scene.add(light);

      // ✅ Add axis helper (size = 5)
      const axesHelper = new THREE.AxesHelper(5);
      scene.add(axesHelper);

      // ✅ Add grid helper (size = 10, divisions = 10)
      const gridHelper = new THREE.GridHelper(10, 10);
      gridHelper.rotation.x = Math.PI / 2; // optional: rotate grid to match your scene orientation
      scene.add(gridHelper);

      animate(); // Start the render loop
    }

    function animate() {
      requestAnimationFrame(animate);
      renderer.render(scene, camera);
    }

    function clearScene() {
      while (scene.children.length > 0)
      {
        scene.remove(scene.children[ 0 ]);
      }
    }

    function plotVectors3D(vectors) {
      clearScene();

      vectors.forEach(v => {
        if (v.vector.length < 3) return; // Need at least 3D

        const x = v.vector[ 0 ];
        const y = v.vector[ 1 ];
        const z = v.vector[ 2 ];

        const geometry = new THREE.SphereGeometry(0.1, 16, 16);
        const material = new THREE.MeshStandardMaterial({
          color: v.type === "image" ? 0xff0000 : v.type === "video" ? 0x0000ff : 0x00aa00
        });

        const sphere = new THREE.Mesh(geometry, material);
        sphere.position.set(x, y, z);
        scene.add(sphere);
      });
    }
    init3DScene();
    plotVectors3D(vectors);
  </script>
  <script>
    async function addVector() {
      const name = document.getElementById("addName").value.trim();
      const vecInput = document.getElementById("addVec").value.trim();
      const vector = vecInput.split(',').map(Number);
      const type = document.querySelector('input[name="addType"]:checked').value;

      if (!name || vector.some(isNaN))
      {
        alert("Please provide a valid name and vector.");
        return;
      }

      const response = await fetch('/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, type, vector })
      });

      if (response.ok)
      {
        alert("Vector added successfully!");
      } else
      {
        alert("Failed to add vector.");
      }
    }

    async function searchVector() {
      const vecInput = document.getElementById("searchVec").value.trim();
      const vector = vecInput.split(',').map(Number);

      if (vector.some(isNaN))
      {
        alert("Please enter a valid search vector.");
        return;
      }

      const response = await fetch('/search', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ vector })
      });

      if (response.ok)
      {
        const result = await response.json();
        document.getElementById("result").innerText =
          `Best Match: ${result.name}, Vector: [${result.vector.join(", ")}]`;
      } else
      {
        document.getElementById("result").innerText = "Error searching for vector.";
      }
    }
    async function fetchAllVectors() {
      const res = await fetch('/all');
      if (!res.ok)
      {
        alert('Failed to fetch vectors');
        return;
      }
      const vectors = await res.json();
      const tbody = document.querySelector('#vectorsTable tbody');
      tbody.innerHTML = ''; // clear old rows

      if (vectors.length === 0)
      {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 2;
        td.style.textAlign = 'center';
        td.textContent = 'No vectors stored yet.';
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      vectors.forEach(v => {
        const tr = document.createElement('tr');

        const nameTd = document.createElement('td');
        nameTd.textContent = v.name;
        tr.appendChild(nameTd);

        const typeTd = document.createElement('td');
        typeTd.textContent = v.type;
        tr.appendChild(typeTd);

        const vecTd = document.createElement('td');
        vecTd.textContent = v.vector.map(x => x.toFixed(3)).join(', ');
        tr.appendChild(vecTd);

        tbody.appendChild(tr);
      });
    }

    fetchAllVectors(); // load on page load
  </script>
</body>

</html>